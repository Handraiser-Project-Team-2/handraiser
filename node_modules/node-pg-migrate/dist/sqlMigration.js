"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const fs_1 = __importDefault(require("fs"));
const util_1 = require("util");
const readFile = util_1.promisify(fs_1.default.readFile);
const createMigrationCommentRegex = (direction) => new RegExp(`^\\s*--[\\s-]*${direction}\\s+migration`, 'im');
exports.getActions = (content) => {
    const upMigrationCommentRegex = createMigrationCommentRegex('up');
    const downMigrationCommentRegex = createMigrationCommentRegex('down');
    const upMigrationStart = content.search(upMigrationCommentRegex);
    const downMigrationStart = content.search(downMigrationCommentRegex);
    const upSql = upMigrationStart >= 0
        ? content.substr(upMigrationStart, downMigrationStart < upMigrationStart ? undefined : downMigrationStart)
        : content;
    const downSql = downMigrationStart >= 0
        ? content.substr(downMigrationStart, upMigrationStart < downMigrationStart ? undefined : upMigrationStart)
        : undefined;
    return {
        up: pgm => pgm.sql(upSql),
        down: downSql === undefined ? false : pgm => pgm.sql(downSql),
    };
};
exports.default = async (sqlPath) => {
    const content = await readFile(sqlPath, 'utf-8');
    return exports.getActions(content);
};
